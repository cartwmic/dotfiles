return {
  {
    "milanglacier/minuet-ai.nvim",
    dependencies = { "nvim-lua/plenary.nvim" },
    event = "VeryLazy",
    config = function()
      local debug = false  -- Set to true to see API key loading messages
      
      -- Shared function to fetch API key from 1Password
      local function fetch_api_key_async(op_path, provider_name, callback)
        local api_key_holder = { value = "placeholder-fetching-from-1password" }
        
        if debug then
          vim.notify(string.format("[minuet] Fetching %s API key from 1Password in background...", provider_name), vim.log.levels.INFO)
        end
        
        vim.system(
          { "timeout", "30s", "op", "read", op_path, "--no-newline" },
          { text = true },
          function(result)
            vim.schedule(function()
              if result.code == 0 and result.stdout and result.stdout ~= "" then
                api_key_holder.value = result.stdout:gsub("%s+$", "")
                if debug then
                  vim.notify(string.format("[minuet] %s API key retrieved (length: %d)", provider_name, #api_key_holder.value), vim.log.levels.INFO)
                end
              else
                local reason = result.code == 124 and "timeout after 30s" or (result.stderr or ""):gsub("%s+$", "")
                vim.notify(string.format("[minuet] Failed to get %s API key: %s", provider_name, reason), vim.log.levels.ERROR)
              end
              if callback then callback() end
            end)
          end
        )
        
        return api_key_holder
      end
      
      -- Shared configuration
      local common_config = {
        cmp = { 
          enable = true,
          enable_auto_complete = false,  -- Only trigger on Alt+y
        },
        blink = { enable = false },
        virtualtext = { enable = false },
        throttle = 1000,
        debounce = 400,
        request_timeout = 5,
        context_window = 8192,
        n_completions = 3,
        notify = "error",  -- Only show errors. Set to "verbose" for troubleshooting
      }
      
      {{- if eq .profile "axon-work-computer" }}
      -- Axon work computer: Use Claude API with 1Password
      local api_key_holder = fetch_api_key_async(
        "op://personal/anthropic - claude/api-key",
        "Claude",
        debug and function()
          vim.notify("[minuet] Setup complete with Claude provider", vim.log.levels.INFO)
        end or nil
      )
      
      require("minuet").setup(vim.tbl_deep_extend("force", common_config, {
        provider = "claude",
        provider_options = {
          claude = {
            api_key = function()
              return api_key_holder.value
            end,
            model = "claude-sonnet-4-20250514",
            optional = {
              max_tokens = 512,
            },
          },
        },
      }))
      {{- else }}
      -- Personal/other profiles: Use Codestral with 1Password
      local api_key_holder = fetch_api_key_async(
        "op://personal/mistral - AI Studio/api-key",
        "Codestral",
        debug and function()
          vim.notify("[minuet] Setup complete with Codestral provider", vim.log.levels.INFO)
        end or nil
      )
      
      require("minuet").setup(vim.tbl_deep_extend("force", common_config, {
        provider = "codestral",
        provider_options = {
          codestral = {
            api_key = function()
              return api_key_holder.value
            end,
            model = "codestral-latest",
            end_point = "https://api.mistral.ai/v1/fim/completions",
            optional = {},
          },
        },
      }))
      {{- end }}
    end,
  },
}




















