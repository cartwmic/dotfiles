# mise.toml - Universal Development Environment Configuration
# Complete replacement for run_onchange_bootstrap_env.sh
#
# Installation:
#   macOS:   brew install mise
#   Ubuntu:  curl https://mise.run | sh
#
# Usage:
#   mise install              # Install all tools
#   mise run bootstrap        # Run full bootstrap including custom tasks
#   mise upgrade              # Upgrade all tools
#
# IMPORTANT: Add to ~/.zshrc EARLY (before other version managers):
#   eval "$(mise activate zsh)"

# =============================================================================
# Core Language Runtimes
# =============================================================================
[tools]
rust = "latest"           # Replaces rustup, provides cargo
python = "latest"         # System Python
node = "lts"              # Replaces nvm

# =============================================================================
# Shell & Terminal Tools
# =============================================================================
starship = "latest"       # Shell prompt
zellij = "latest"         # Terminal multiplexer
zoxide = "latest"         # Smart cd replacement

# Zsh plugins via GitHub backend
"github:mattmc3/antidote" = "latest"     # Zsh plugin manager
"github:junegunn/fzf" = "latest"         # Fuzzy finder
"github:Aloxaf/fzf-tab" = "latest"       # Fzf tab completion

# =============================================================================
# Development Tools
# =============================================================================
neovim = "latest"         # Editor
lazygit = "latest"        # Git TUI
ripgrep = "latest"        # Fast grep alternative

# Build tools & task runners
"cargo:just" = "latest"                  # Rust-based task runner
"github:go-task/task" = "latest"         # Go-based task runner

# =============================================================================
# Kubernetes Tools
# =============================================================================
kubectl = "latest"        # Kubernetes CLI
k9s = "latest"            # Kubernetes TUI
helm = "latest"           # Kubernetes package manager
kustomize = "latest"      # Kubernetes config management
"github:bitnami-labs/sealed-secrets" = "latest"  # kubeseal

# =============================================================================
# Infrastructure & Cloud
# =============================================================================
terraform = "latest"      # Infrastructure as Code

# =============================================================================
# Data Processing
# =============================================================================
jq = "latest"             # JSON processor
yq = "latest"             # YAML processor

# =============================================================================
# Security & Encryption
# =============================================================================
"cargo:rage" = "latest"   # Age encryption tool

# =============================================================================
# AI & Productivity Tools (require node)
# =============================================================================
"npm:@mermaid-js/mermaid-cli" = "latest"         # Diagram generation (mmdc)
"npm:@zed-industries/claude-code-acp" = "latest" # Claude ACP

# =============================================================================
# Tool Options
# =============================================================================
[tools."cargo:just"]
locked = true

[tools."cargo:rage"]
locked = true

# =============================================================================
# Environment Variables
# =============================================================================
[env]
# mise will manage PATH automatically

# =============================================================================
# Custom Installation Tasks
# =============================================================================

[tasks."setup-ubuntu-essentials"]
description = "Install Ubuntu base packages and set zsh as default shell"
run = '''
sudo apt-get update
sudo apt-get install -y build-essential software-properties-common jq tar curl wget \
  git sed gnupg zip zsh fontconfig util-linux bison mercurial
sudo chsh "$USER" -s /usr/bin/zsh
'''
condition = '[[ "$OSTYPE" == "linux-gnu"* ]]'

[tasks."install-uv"]
description = "Install uv (Python package installer)"
run = 'curl -LsSf https://astral.sh/uv/install.sh | sh'
condition = '! command -v uv &> /dev/null'

[tasks."install-uv-tools"]
description = "Install Python tools via uv"
depends = ["install-uv"]
run = '''
uv tool install vectorcode
uv tool install mistral-vibe
'''
condition = '! command -v vectorcode &> /dev/null || ! command -v vibe &> /dev/null'

[tasks."install-sdkman"]
description = "Install SDKMAN (Java/JVM tools)"
run = 'curl -s "https://get.sdkman.io" | bash'
condition = '! command -v sdk &> /dev/null'

[tasks."install-kitty"]
description = "Install Kitty terminal emulator"
run = 'curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin'
condition = '! command -v kitty &> /dev/null'

[tasks."install-claude"]
description = "Install Claude CLI"
run = 'curl -fsSL https://claude.ai/install.sh | bash'
condition = '! command -v claude &> /dev/null'

[tasks."install-imagemagick-macos"]
description = "Install ImageMagick with XQuartz on macOS"
run = '''
brew install imagemagick xquartz
echo "âš ï¸  REMEMBER TO ADD XQUARTZ AS A LOGIN ITEM"
'''
condition = '[[ "$OSTYPE" == "darwin"* ]] && ! command -v magick &> /dev/null'

[tasks."install-imagemagick-ubuntu"]
description = "Install ImageMagick on Ubuntu"
run = 'sudo apt-get install -y imagemagick'
condition = '[[ "$OSTYPE" == "linux-gnu"* ]] && ! command -v magick &> /dev/null'

[tasks."install-fonts-macos"]
description = "Install Nerd Fonts on macOS"
run = 'brew install --cask font-sauce-code-pro-nerd-font'
condition = '[[ "$OSTYPE" == "darwin"* ]]'

[tasks."install-fonts-ubuntu"]
description = "Install Nerd Fonts on Ubuntu"
run = '''
VERSION=$(curl -s https://api.github.com/repos/ryanoasis/nerd-fonts/tags | jq -r '.[0].name')
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"
curl -L -o SourceCodePro.zip "https://github.com/ryanoasis/nerd-fonts/releases/download/$VERSION/SourceCodePro.zip"
unzip SourceCodePro.zip
mkdir -p "$HOME/.local/share/fonts"
mv ./*ttf "$HOME/.local/share/fonts"
fc-cache -fv
cd - && rm -rf "$TEMP_DIR"
'''
condition = '[[ "$OSTYPE" == "linux-gnu"* ]]'

[tasks."install-fonts"]
description = "Install fonts for current platform"
depends = ["install-fonts-*"]

[tasks."setup-fzf-shell"]
description = "Setup fzf shell integration"
run = '''
FZF_PATH=$(mise where fzf)
if [ -f "$FZF_PATH/install" ]; then
  "$FZF_PATH/install" --all
fi
'''
condition = '! test -f ~/.fzf.zsh'

[tasks.bootstrap]
description = "Complete system bootstrap"
depends = [
  "setup-ubuntu-essentials",
  "install-uv",
  "install-uv-tools",
  "install-sdkman",
  "install-kitty",
  "install-claude",
  "install-imagemagick-macos",
  "install-imagemagick-ubuntu",
  "install-fonts",
  "setup-fzf-shell"
]
run = '''
echo "âœ… Bootstrap complete!"
echo ""
echo "ğŸ“ Manual steps remaining:"
echo "  1. Install gvm manually: bash < <(curl -LSs 'https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer')"
echo "  2. Set a default Go version with gvm"
if [[ "$OSTYPE" == "darwin"* ]]; then
  echo "  3. [macOS] Add XQuartz as a login item"
fi
echo ""
echo "âš ï¸  Restart your shell or run: source ~/.zshrc"
'''

# =============================================================================
# Settings
# =============================================================================
[settings]
experimental = true
jobs = 4
verbose = false

# =============================================================================
# Installation Paths & CLI Availability
# =============================================================================
#
# mise installs tools to: ~/.local/share/mise/installs/<tool>/<version>/
# Access tool paths with: mise where <tool>
#
# GitHub backend tools:
#   github:owner/repo â†’ ~/.local/share/mise/installs/github-owner-repo/<version>/
#
# Version Manager CLIs:
#   - nvm: mise has built-in node support, does NOT install nvm CLI
#     * Full version switching: mise use node@20, mise use node@18, etc.
#     * Reads .nvmrc and .node-version files automatically
#     * Commands: mise install node@X, mise use node@X, mise ls node
#     * Drop-in replacement for nvm functionality
#   - rustup: mise replaces rustup CLI entirely
#   - gvm: NOT managed by mise, must install manually (same as bootstrap)
#   - SDKMAN: Installed via task, SDK CLI remains available
#   - uv: Installed via task, uv CLI remains available
#
# Shell Integration:
#   - fzf: Binary installed by mise, shell integration via setup-fzf-shell task
#   - antidote: Installed by mise, sourced in zshrc via $(mise where antidote)
#   - fzf-tab: Installed by mise, sourced in zshrc via $(mise where fzf-tab)
#
# =============================================================================
# Tool Coverage Audit
# =============================================================================
#
# Bootstrap script tools â†’ mise mapping:
#
# âœ… Prerequisites:
#   - uv â†’ task (curl installer)
#   - cargo/rust â†’ rust in [tools]
#
# âœ… Language runtimes:
#   - nvm â†’ node in [tools]
#   - rustup â†’ rust in [tools]
#   - python â†’ python in [tools]
#   - gvm â†’ MANUAL (as in bootstrap)
#   - sdkman â†’ task (as in bootstrap)
#
# âœ… Shell tools:
#   - antidote â†’ github:mattmc3/antidote
#   - fzf â†’ github:junegunn/fzf (+ postinstall)
#   - fzf-tab â†’ github:Aloxaf/fzf-tab
#   - starship â†’ starship
#   - zellij â†’ zellij
#   - zoxide â†’ zoxide
#
# âœ… Dev tools:
#   - neovim â†’ neovim
#   - lazygit â†’ lazygit
#   - ripgrep â†’ ripgrep
#   - just â†’ cargo:just
#   - rage â†’ cargo:rage
#   - go-task â†’ github:go-task/task
#
# âœ… Kubernetes:
#   - kubectl â†’ kubectl
#   - k9s â†’ k9s
#   - helm â†’ helm
#   - kustomize â†’ kustomize
#   - kubeseal â†’ github:bitnami-labs/sealed-secrets
#
# âœ… Infrastructure:
#   - terraform â†’ terraform
#   - yq â†’ yq
#   - jq â†’ jq (mise includes this)
#
# âœ… AI/Productivity:
#   - vectorcode â†’ task (uv tool install)
#   - mistral-vibe â†’ task (uv tool install)
#   - mmdc â†’ npm:@mermaid-js/mermaid-cli
#   - claude â†’ task (custom installer)
#   - claude-code-acp â†’ npm:@zed-industries/claude-code-acp
#
# âœ… Platform-specific:
#   - kitty â†’ task (custom installer)
#   - imagemagick â†’ tasks (platform-specific)
#   - fonts â†’ tasks (platform-specific)
#
# âœ… Manual (as in bootstrap):
#   - gvm
#   - XQuartz login item (macOS)
