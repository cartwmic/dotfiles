#!/bin/sh
# Chezmoi run_onchange script to bootstrap environment with mise
# This runs whenever mise config changes
#
# The hash comment below tells chezmoi to re-run this script when mise config changes
# Hash: {{ include "dot_config/mise/config.toml" | sha256sum }}

set -eu

SCRIPT_NAME="$(basename "$0")"
LOG_PREFIX="[${SCRIPT_NAME}]"

log_info() {
  echo "${LOG_PREFIX} INFO: $*" >&2
}

log_error() {
  echo "${LOG_PREFIX} ERROR: $*" >&2
}

# Ensure mise is in PATH
if ! command -v mise &> /dev/null; then
  # Try to find mise in common locations
  if [ -f "$HOME/.local/bin/mise" ]; then
    export PATH="$HOME/.local/bin:$PATH"
  elif [ -f "/opt/homebrew/bin/mise" ]; then
    export PATH="/opt/homebrew/bin:$PATH"
  elif [ -f "/usr/local/bin/mise" ]; then
    export PATH="/usr/local/bin:$PATH"
  else
    log_error "mise not found in PATH. Please ensure mise is installed first."
    log_error "Run: chezmoi apply to trigger run_once_install_mise.sh"
    exit 1
  fi
fi

log_info "mise version: $(mise --version)"
log_info "Installing tools from mise config..."

# Install all tools defined in [tools] section
mise install

log_info "Running mise bootstrap tasks..."

# Run the bootstrap task which includes all custom installations
mise run bootstrap

log_info "mise bootstrap complete!"
log_info "Please restart your shell or run: exec zsh"
