#!/bin/sh
# Chezmoi run_onchange script to bootstrap environment with mise
# This runs whenever mise.toml changes
#
# The hash comment below tells chezmoi to re-run this script when mise.toml changes
# Hash: {{ include "dot_config/mise/config.toml" | sha256sum }}

set -eu

SCRIPT_NAME="$(basename "$0")"
LOG_PREFIX="[${SCRIPT_NAME}]"

log_info() {
  echo "${LOG_PREFIX} INFO: $*" >&2
}

log_error() {
  echo "${LOG_PREFIX} ERROR: $*" >&2
}

# Ensure mise is in PATH
if ! command -v mise &> /dev/null; then
  # Try to find mise in common locations
  if [ -f "$HOME/.local/bin/mise" ]; then
    export PATH="$HOME/.local/bin:$PATH"
  elif [ -f "/usr/local/bin/mise" ]; then
    export PATH="/usr/local/bin:$PATH"
  else
    log_error "mise not found in PATH. Please run run_once_install_mise.sh first."
    exit 1
  fi
fi

log_info "mise version: $(mise --version)"
log_info "Installing tools from mise.toml..."

# Install all tools defined in [tools] section
mise install

log_info "Running mise bootstrap tasks..."

# Run the bootstrap task which includes all custom installations
mise run bootstrap

log_info "mise bootstrap complete!"
log_info "You may need to restart your shell or run: source ~/.zshrc"
