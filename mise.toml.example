# mise.toml - Universal Development Environment Configuration
# This replaces the run_onchange_bootstrap_env.sh script
#
# IMPORTANT: This is NOT a complete drop-in replacement for the bootstrap script.
# See the "Critical Differences" section at the bottom for details.
#
# Installation:
#   macOS:   brew install mise
#   Ubuntu:  curl https://mise.run | sh
#
# After installing mise, run: mise install && mise run bootstrap
# Add to ~/.zshrc: eval "$(mise activate zsh)"

# =============================================================================
# Language Runtimes & Version Managers
# =============================================================================
[tools]
# Core language runtimes (mise's primary strength)
# NOTE: node/nvm installed via task to match bootstrap script behavior
python = "latest"         # System Python management
rust = "latest"           # Replaces rustup (includes cargo)
# NOTE: go/gvm handled manually - see bootstrap task notes
# NOTE: java/SDKMAN handled manually - see bootstrap task notes

# =============================================================================
# Shell & Terminal Tools
# =============================================================================
# NOTE: antidote, fzf, and fzf-tab are installed via tasks to match bootstrap
# script's git clone behavior to specific directories
starship = "latest"                          # Shell prompt (from registry)
zellij = "latest"                            # Terminal multiplexer (from registry)
zoxide = "latest"                            # Smart directory jumper

# =============================================================================
# Development Tools
# =============================================================================
# Editor and Git UI
neovim = "stable"                            # Text editor
lazygit = "latest"                           # Git TUI (from registry)

# Build tools and task runners
"cargo:just" = "latest"                      # Command runner (Rust)
"github:go-task/task" = "latest"             # Task runner (Go alternative)

# Code search and CLI productivity
ripgrep = "latest"                           # Fast grep alternative
"cargo:rage" = "latest"                      # Age encryption tool

# =============================================================================
# Kubernetes & Cloud Tools
# =============================================================================
kubectl = "latest"                           # Kubernetes CLI
k9s = "latest"                               # Kubernetes TUI
helm = "latest"                              # Kubernetes package manager
kustomize = "latest"                         # Kubernetes config management
"github:bitnami-labs/sealed-secrets" = "latest"  # Kubeseal for secret encryption
terraform = "latest"                         # Infrastructure as Code

# =============================================================================
# Data & Config Processing
# =============================================================================
jq = "latest"                                # JSON processor
yq = "latest"                                # YAML processor (from registry)

# =============================================================================
# Platform-Specific Tools
# =============================================================================
# Image processing (macOS: via brew with xquartz, Ubuntu: via apt)
# Note: imagemagick needs special handling - see [tasks.install-imagemagick]

# Terminal emulator
# Note: kitty installation handled by task due to custom installer

# =============================================================================
# AI & Developer Productivity Tools
# =============================================================================
# NOTE: Python tools (vectorcode, mistral-vibe) installed via uv in tasks
# to match bootstrap script which uses "uv tool install"

# Node.js-based tools via npm backend
# NOTE: These require nvm to be installed first - see tasks
"npm:@mermaid-js/mermaid-cli" = "latest"     # Diagram generation (mmdc)
"npm:@zed-industries/claude-code-acp" = "latest"  # Claude ACP

# Claude CLI (custom installer)
# Note: Handled by task due to custom installation script

# =============================================================================
# Fonts
# =============================================================================
# Note: Fonts require platform-specific installation - see tasks below

# =============================================================================
# Tool Configuration & Options
# =============================================================================
# Specific tool options can be configured here
[tools."cargo:just"]
locked = true                                # Use Cargo.lock for reproducibility

[tools."cargo:rage"]
locked = true

# =============================================================================
# Environment Variables
# =============================================================================
[env]
# Add any global environment variables here
# _.file = ".env"  # Optionally load from .env file

# =============================================================================
# Custom Installation Tasks
# =============================================================================
# Some tools require custom installation logic that mise can't handle directly
# Run these with: mise run <task-name>

[tasks."install-fonts-macos"]
description = "Install Nerd Fonts on macOS"
run = "brew install --cask font-sauce-code-pro-nerd-font"
condition = '[[ "$OSTYPE" == "darwin"* ]]'

[tasks."install-fonts-ubuntu"]
description = "Install Nerd Fonts on Ubuntu"
run = '''
VERSION=$(curl -s https://api.github.com/repos/ryanoasis/nerd-fonts/tags | jq -r '.[0].name')
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"
curl -L -o SourceCodePro.zip "https://github.com/ryanoasis/nerd-fonts/releases/download/$VERSION/SourceCodePro.zip"
unzip SourceCodePro.zip
mkdir -p "$HOME/.local/share/fonts"
mv ./*ttf "$HOME/.local/share/fonts"
fc-cache -fv
cd - && rm -rf "$TEMP_DIR"
'''
condition = '[[ "$OSTYPE" == "linux-gnu"* ]]'

[tasks."install-fonts"]
description = "Install fonts for current platform"
depends = ["install-fonts-*"]

[tasks."install-kitty"]
description = "Install Kitty terminal emulator"
run = '''
curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin
'''
condition = '! command -v kitty &> /dev/null'

[tasks."install-claude"]
description = "Install Claude CLI"
run = 'curl -fsSL https://claude.ai/install.sh | bash'
condition = '! command -v claude &> /dev/null'

[tasks."install-imagemagick-macos"]
description = "Install ImageMagick with XQuartz on macOS"
run = '''
brew install imagemagick xquartz
echo "‚ö†Ô∏è  REMEMBER TO ADD XQUARTZ AS A LOGIN ITEM"
'''
condition = '[[ "$OSTYPE" == "darwin"* ]] && ! command -v magick &> /dev/null'

[tasks."install-imagemagick-ubuntu"]
description = "Install ImageMagick on Ubuntu"
run = 'sudo apt-get install -y imagemagick'
condition = '[[ "$OSTYPE" == "linux-gnu"* ]] && ! command -v magick &> /dev/null'

[tasks."setup-ubuntu-essentials"]
description = "Install Ubuntu base packages and set zsh as default shell"
run = '''
sudo apt-get update
sudo apt-get install -y build-essential software-properties-common jq tar curl wget \
  git sed gnupg zip zsh fontconfig sed util-linux bison mercurial
sudo chsh "$USER" -s /usr/bin/zsh
'''
condition = '[[ "$OSTYPE" == "linux-gnu"* ]]'

[tasks."install-uv"]
description = "Install uv (Python package manager)"
run = 'curl -LsSf https://astral.sh/uv/install.sh | sh'
condition = '! command -v uv &> /dev/null'

[tasks."install-nvm"]
description = "Install nvm (Node version manager)"
run = '''
NVM_VERSION=$(curl -s https://api.github.com/repos/nvm-sh/nvm/tags | jq -r '.[0].name')
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/"$NVM_VERSION"/install.sh | bash
'''
condition = '! test -e "$HOME/.config/nvm"'

[tasks."install-antidote"]
description = "Install antidote (Zsh plugin manager)"
run = 'git clone --depth=1 https://github.com/mattmc3/antidote.git "$HOME/.antidote"'
condition = '! test -e "$HOME/.antidote"'

[tasks."install-fzf"]
description = "Install fzf with shell integration"
run = '''
git clone --depth 1 https://github.com/junegunn/fzf.git "$HOME/.fzf"
"$HOME/.fzf/install" --all
'''
condition = '! test -e "$HOME/.fzf"'

[tasks."install-fzf-tab"]
description = "Install fzf-tab (Zsh completion enhancement)"
run = 'git clone https://github.com/Aloxaf/fzf-tab "$HOME/fzf-tab"'
condition = '! test -e "$HOME/fzf-tab"'

[tasks."install-sdkman"]
description = "Install SDKMAN (Java/JVM tool manager)"
run = 'curl -s "https://get.sdkman.io" | bash'
condition = '! command -v sdk &> /dev/null'

[tasks."install-uv-tools"]
description = "Install Python tools via uv"
depends = ["install-uv"]
run = '''
uv tool install vectorcode
uv tool install mistral-vibe
'''
condition = '! command -v vectorcode &> /dev/null || ! command -v vibe &> /dev/null'

[tasks.bootstrap]
description = "Complete system bootstrap - install all tools and fonts"
depends = [
  "setup-ubuntu-essentials",
  "install-uv",
  "install-nvm",
  "install-antidote",
  "install-fzf",
  "install-fzf-tab",
  "install-sdkman",
  "install-uv-tools",
  "install-fonts",
  "install-kitty",
  "install-claude",
  "install-imagemagick-macos",
  "install-imagemagick-ubuntu"
]
run = '''
echo "‚úÖ Bootstrap complete!"
echo ""
echo "üìù Manual steps still required:"
echo "  1. Install gvm manually: bash < <(curl -LSs 'https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer')"
echo "  2. Set a default Go version with gvm after installation"
if [[ "$OSTYPE" == "darwin"* ]]; then
  echo "  3. [macOS] Add XQuartz as a login item"
fi
echo ""
echo "‚ö†Ô∏è  IMPORTANT: You may need to restart your shell or source ~/.zshrc for all changes to take effect"
'''

# =============================================================================
# Settings
# =============================================================================
[settings]
# Automatically install missing tools when entering a directory
experimental = true
# Use all CPU cores for parallel installation
jobs = 4
# Set verbose output for debugging
verbose = false

# =============================================================================
# Shell Aliases (optional)
# =============================================================================
# Aliases that are only active when in this directory
# [alias]
# ll = "ls -la"

# =============================================================================
# Notes & Migration Guide
# =============================================================================
#
# CRITICAL DIFFERENCES from bootstrap script:
#
# This mise configuration is designed to replicate the bootstrap script behavior
# as closely as possible, but there are important differences:
#
# 1. **Installation locations match original**:
#    - nvm ‚Üí $HOME/.config/nvm (git clone + install script)
#    - antidote ‚Üí $HOME/.antidote (git clone)
#    - fzf ‚Üí $HOME/.fzf (git clone + shell integration)
#    - fzf-tab ‚Üí $HOME/fzf-tab (git clone)
#    - SDKMAN ‚Üí installed via curl script
#    - uv ‚Üí installed via curl script
#
# 2. **Tools managed by mise** (in mise's tool directory):
#    - rust/cargo
#    - python
#    - Most CLI tools (kubectl, helm, k9s, terraform, etc.)
#    - cargo packages (just, rage)
#    - npm packages (mmdc, claude-code-acp) - requires nvm first
#
# 3. **Manual installation still required**:
#    - gvm: bash < <(curl -LSs 'https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer')
#    - After gvm: Set a default Go version
#    - [macOS only] Add XQuartz as a login item
#
# =============================================================================
# Chezmoi Integration
# =============================================================================
#
# To integrate mise with chezmoi for automatic environment setup:
#
# 1. Create run_once_install_mise.sh in your chezmoi source:
#    #!/bin/sh
#    if ! command -v mise &> /dev/null; then
#      if [[ "$OSTYPE" == "darwin"* ]]; then
#        brew install mise
#      else
#        curl https://mise.run | sh
#      fi
#    fi
#
# 2. Rename this file to dot_config/mise/config.toml in chezmoi source
#    (This will be deployed to ~/.config/mise/config.toml)
#
# 3. Create run_onchange_mise_bootstrap.sh.tmpl:
#    #!/bin/sh
#    # Hash: {{ include "dot_config/mise/config.toml" | sha256sum }}
#    mise install
#    mise run bootstrap
#
# This ensures:
# - mise is installed once when setting up a new machine
# - mise.toml is managed by chezmoi and synced across machines
# - Tools are reinstalled whenever mise.toml changes
#
# =============================================================================
# Usage
# =============================================================================
#
# Basic commands:
#   mise install              # Install all tools defined in [tools]
#   mise run bootstrap        # Run full bootstrap (tools + tasks)
#   mise upgrade              # Upgrade all tools to latest
#   mise ls                   # List installed tools
#   mise doctor               # Diagnose issues
#
# Version management (if using mise for node/go/java instead of nvm/gvm/sdkman):
#   mise use node@20          # Switch to specific version
#   mise use go@latest        # Use latest Go version
#   mise local python@3.11    # Set Python version for current directory only
